@page
@model CreateModel
@{
	ViewData.SetTitle("Create Private Message");
}

<div condition="Model.IsReply" class="card mb-3">
	<div class="card-header">
		<button type="button" id="quote-btn" class="float-end btn btn-sm btn-secondary">Quote</button>
		@Model.ReplyingTo!.Subject
	</div>
	<div class="card-body">
		<div class="card-title">
			@Model.ReplyingTo.FromUserName <span class="fa fa-arrow-right"></span> @Model.ReplyingTo.ToUserName
		</div>
		<div class="card-text" id="replying-to-text">@Model.ReplyingTo.Text</div>
	</div>
</div>

<form method="POST" id="create-form">
	<row>
		<fieldset class="col-lg-6">
			<label asp-for="Subject" class="form-control-label"></label>
			<input type="text" asp-for="Subject" list="search-username-list" class="form-control" autocomplete="off" />
			<span asp-validation-for="Subject" class="text-danger"></span>
		</fieldset>
		<fieldset class="col-lg-6">
			<div id="user-form-group" class="mb-2">
				<label asp-for="ToUser" class="form-control-label"></label>
				<input type="text" asp-for="ToUser" class="form-control" autocomplete="off" placeholder="@Html.DescriptionFor(m => m.ToUser)"/>
				<span asp-validation-for="ToUser" class="text-danger"></span>
			</div>
			<label for="group-select">To Group</label>
			<select id="group-select" name="@Html.NameFor(m => m.ToUser)" class="form-control" asp-items="@Model.AvailableGroupRoles">
			</select>
		</fieldset>
	</row>
	<fullrow>
		<partial name="Forum/_CreatePostHelper" model="@("Text")" />
	</fullrow>
	<row>
		<fieldset class="col-12">
			<label asp-for="Text" class="form-control-label"></label>
			<textarea asp-for="Text" class="form-control" rows="20"></textarea>
			<span asp-validation-for="Text" class="text-danger"></span>
		</fieldset>
	</row>
	<form-button-bar>
		<preview-button></preview-button>
		<submit-button disable="@string.IsNullOrWhiteSpace(Model.ToUser)"><i class="fa fa-save"></i> Send</submit-button>
		<cancel-button asp-page="Inbox"></cancel-button>
	</form-button-bar>
</form>

<partial name="_PreviewWindow" model="@((nameof(Model.Text), "/Forum/Preview"))" />

@section Scripts {
	<partial name="_ValidationScriptsPartial" />
	<script src="/js/user-search.js"></script>
	<script>
		const userBoxElemId = '@Html.IdFor(m => m.ToUser)';
		const userFormGroup = document.getElementById('user-form-group');
		const userBox = document.getElementById(userBoxElemId);
		const formSubmitBtn = userBox
			.closest('form')
			.querySelector("button[type='Submit']");

		searchUsers(userBoxElemId);
		if (document.getElementById('quote-btn')) {
			document.getElementById('quote-btn').onclick = function () {
				const text = document.getElementById('replying-to-text').innerHTML;
				document.getElementById('@Html.IdFor(m => m.Text)').innerHTML = `[quote]${text}[/quote]`;
			};
		}

		const groupSelect = document.getElementById('group-select');
		groupSelect.addEventListener('change', () => {
			if (groupSelect.value) {
				userBox.value = groupSelect.value;
				formSubmitBtn.removeAttribute('disabled');

				userFormGroup.classList.add('d-none');
			} else {
				userBox.value = '';
				userFormGroup.classList.remove('d-none');
				formSubmitBtn.setAttribute('disabled', 'disabled');
			}
		});
	</script>
}
