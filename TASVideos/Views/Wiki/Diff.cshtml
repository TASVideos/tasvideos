@model WikiDiffModel

@{
	ViewData["Title"] = $"{Model.PageName} - Diff r{Model.LeftRevision} - r{Model.RightRevision}";
}

<input type="hidden" asp-for="LeftMarkup" rows="8" class="form-control" />
<input type="hidden" asp-for="RightMarkup" rows="8" class="form-control" />

<row>
	<label><input name="diff-type" type="radio" value="1" checked="checked" /> Inline</label>
	<label><input name="diff-type" type="radio" value="0" /> Side by Side</label>
</row>
<hr />
<row>
	<div id="ResultMarkup"></div>
</row>

<script type="text/javascript">
	document.addEventListener("DOMContentLoaded", function (event) {
		generateDiff(1);
	});

	document.querySelectorAll('[name="diff-type"]')
		.toArray()
		.forEach(function (elem) {
			elem.addEventListener('click', onRadioChange);
		});

	function onRadioChange(e) {
		var type = document.querySelector('[name="diff-type"]:checked').value;
		generateDiff(parseInt(type));
	}

	function generateDiff(viewType) {
		var leftMarkup = document.getElementById('LeftMarkup').value;
		var rightMarkup = document.getElementById('RightMarkup').value;
		var diffElem = document.getElementById('ResultMarkup');

		var base = difflib.stringAsLines(leftMarkup);
		var newtxt = difflib.stringAsLines(rightMarkup);
		var opcodes = new difflib.SequenceMatcher(base, newtxt).get_opcodes();

		diffElem.innerHTML = "";

		diffElem.appendChild(diffview.buildView({
			baseTextLines: base,
			newTextLines: newtxt,
			opcodes: opcodes,
			baseTextName:  "r@(Model.LeftRevision)",
			newTextName: "r@(Model.RightRevision)",
			contextSize: null,
			viewType: viewType
		}));
	}
</script>

@section Scripts {
	<script src="~/js/difflib.js"></script>
	<script src="~/js/diffview.js"></script>
	<link rel="stylesheet" href="~/css/diffview.css"/>
}
